<!DOCTYPE html>
<html>
  <head>
    <title>RxJs Canvas</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/rxjs/4.1.0/rx.all.js"></script>
    <script>
function canvasSpaceGame() {
  // Get the canvas element.
  var canvas = document.getElementById("myCanvas");

  // Specify 2d canvas type.
  var ctx = canvas.getContext("2d");
  ctx.rect(0, 0, 300, 300);
  ctx.fillStyle = "black";
  ctx.fill();
  black = ctx.getImageData(0, 0, 30, 30);

  // Draw space ship.
  var ship = makeShip(ctx);

  // initial ship position
  var initial = {x: 0, y: 0};

  var keyDowns = Rx.Observable.fromEvent(window, 'keydown')
    .pluck('code')
    .filter(key => ['ArrowRight', 'ArrowLeft', 'ArrowDown', 'ArrowUp'].includes(key))

    var clicks = Rx.Observable.fromEvent(canvas, 'click')

    keyDowns
    .merge(clicks)
    .scan((acc, code) => {
      switch(code) {
      case 'ArrowRight': return goRight(acc);
      case 'ArrowLeft': return goLeft(acc);
      case 'ArrowDown': return goDown(acc);
      case 'ArrowUp': return goUp(acc);
      default: return goClick(code);
      }
    },initial)
    .startWith(initial)
    .pairwise()
    .subscribe(
        position => {
          paint(ctx, black, ship, position)
        },
        error => console.log(error)
        );

}


function paint(ctx, black, ship, position) {
  // Put black background down to erase shipe.
  ctx.putImageData(black,  position[0].x, position[0].y);

  // Put ship in new position.
  ctx.putImageData(ship, position[1].x, position[1].y);

}

function goClick(event) {
  return {
    x: event.offsetX,
    y: event.offsetY,
  };
}

function goUp(acc) {
  var y = acc.y - 30;
  if (y < 0) {
    y = 0;
  }

  return {
    x: acc.x,
    y: y
  };
}

function goDown(acc) {
  var y = acc.y + 30;
  if (y > 270) {
    y = 270;
  }

  return {
    x: acc.x,
    y: y
  };
}

function goRight(acc) {
  var x = acc.x + 30;
  if (x > 270) {
    x = 270;
  }

  return {
    x: x,
    y: acc.y
  };
}

function goLeft(acc) {
  var x = acc.x - 30;
  if (x < 0) {
    x = 0;
  }

  return {
    x: x,
    y: acc.y
  };
}

function makeShip(ctx) {

  // Paint it black.
  ctx.fillStyle = "black";
  ctx.rect(0, 0, 300, 300);
  ctx.fill();

  // Draw saucer bottom.
  ctx.beginPath();
  ctx.moveTo(28.4, 16.9);
  ctx.bezierCurveTo(28.4, 19.7, 22.9, 22.0, 16.0, 22.0);
  ctx.bezierCurveTo(9.1, 22.0, 3.6, 19.7, 3.6, 16.9);
  ctx.bezierCurveTo(3.6, 14.1, 9.1, 11.8, 16.0, 11.8);
  ctx.bezierCurveTo(22.9, 11.8, 28.4, 14.1, 28.4, 16.9);
  ctx.closePath();
  ctx.fillStyle = "rgb(222, 103, 0)";
  ctx.fill();

  // Draw saucer top.
  ctx.beginPath();
  ctx.moveTo(22.3, 12.0);
  ctx.bezierCurveTo(22.3, 13.3, 19.4, 14.3, 15.9, 14.3);
  ctx.bezierCurveTo(12.4, 14.3, 9.6, 13.3, 9.6, 12.0);
  ctx.bezierCurveTo(9.6, 10.8, 12.4, 9.7, 15.9, 9.7);
  ctx.bezierCurveTo(19.4, 9.7, 22.3, 10.8, 22.3, 12.0);
  ctx.closePath();
  ctx.fillStyle = "rgb(51, 190, 0)";
  ctx.fill();

  // Save ship data.
  return ctx.getImageData(0, 0, 30, 30);
}




    </script>
  </head>
  <body onload="canvasSpaceGame()">
    <h1>
      Canvas Space Game
    </h1>
    <canvas id="myCanvas" width="300" height="300">
    </canvas>
  </body>
</html>
